# 一个限制同一个用户同时在线引发的思考
在一个互联网系统中，通常会限制同一个用户的同时登陆限制。比如 QQ 在一个电脑登陆了另外一个电脑就下线了（不对比不同终端类型）。再或者有些企业应用会以用户数来收费，此时就要限制同一时间同一个用户的在线数量，从而获得更多的利益。在还是单体应用的年代的时候还是很幸福的，只要在一个 JVM 下控制住就可以了。然而到现在是集群、分布式、微服务等。导致需要做这种限制的难度加大。


#### 据说老板的要求如下

* 可动态配置限制的在线数（大于等于1）
* 务必可靠（因为如果不可靠会导致出现以为被盗号？）
* 提示下线原因

#### 设计想法
根据 CAP 定律，在分布性下面只能满足2个条件。我们的做法是抛弃掉强一致性。使用的是最终一致性来补偿。

首先，session 使用 `redis` 管理（或者使用 `spring-data` 作为 session 管理），步骤如下：

* 登陆的时候把登陆信息压入消息队列
* 消息队列取出的时候按照用户进行分组消费（多线程消费，保证先后顺序），再者可以达到削峰效果
* 退出的时候直接销毁掉


使用的 Listener 如下：

```java
javax.servlet.http.HttpSessionAttributeListener
javax.servlet.http.HttpSessionListener
```

#### 压力测试
多线程压力测试


一个限制用户登录引发的思想
1. 限制登录个数
2. 高并发的时候如何做到准确无误的挤掉超过的数量
3. 如何消费


